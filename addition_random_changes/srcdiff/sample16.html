<!DOCTYPE html>
<html><head><meta charset="UTF-8"><title>Tool3</title></head><body><div style="font-family: courier, monospace;"><table style="border-collapse: collapse;"><tr><td style="border: 1px solid black;"><table><tr><th><strong>Original</strong></th></tr><tr><td><pre><span><span style="color: grey"> 1 </span></span><span><span style="background-color: transparent">@Override</span></span><span><span style="background-color: transparent">
</span></span><span><span style="color: grey"> 2 </span></span><span><span style="background-color: transparent">public StringTerms buildAggregation(long owningBucketOrdinal) {</span></span><span><span style="background-color: transparent">
</span></span><span><span style="color: grey"> 3 </span></span><span><span style="background-color: transparent">    assert owningBucketOrdinal == 0;</span></span><span><span style="background-color: transparent">
</span></span><span><span style="color: grey"> 4 </span></span><span><span style="background-color: transparent">    final int size = (int) Math.min(bucketOrds.size(), shardSize);</span></span><span><span style="background-color: transparent">
</span></span><span><span style="color: grey"> 5 </span></span><span><span style="background-color: transparent"></span></span><span><span style="background-color: transparent">
</span></span><span><span style="color: grey"> 6 </span></span><span><span style="background-color: transparent">    BucketPriorityQueue ordered = new BucketPriorityQueue(size, order.comparator());</span></span><span><span style="background-color: transparent">
</span></span><span><span style="color: grey"> 7 </span></span><span><span style="background-color: transparent">    </span></span><span style="color:grey; text-decoration: line-through;"><span style="color: black; background-color: rgb(255,187,187); font-weight: bold;">OrdinalBucket</span></span><span><span style="background-color: transparent"> spare = null;</span></span><span><span style="background-color: transparent">
</span></span><span><span style="color: grey"> 8 </span></span><span><span style="background-color: transparent">    for (int i = 0; i &lt; bucketOrds.size(); </span></span><span style="color:grey; text-decoration: line-through;"><span style="color: black; background-color: rgb(255,187,187); font-weight: bold;">++</span></span><span><span style="background-color: transparent">i) {</span></span><span><span style="background-color: transparent">
</span></span><span><span style="color: grey"> 9 </span></span><span><span style="background-color: transparent">        if (spare == null) {</span></span><span><span style="background-color: transparent">
</span></span><span><span style="color: grey">10 </span></span><span><span style="background-color: transparent">            spare = new </span></span><span style="color:grey; text-decoration: line-through;"><span style="color: black; background-color: rgb(255,187,187); font-weight: bold;">OrdinalBucket()</span></span><span><span style="background-color: transparent">;</span></span><span><span style="background-color: transparent">
</span></span><span><span style="color: grey">11 </span></span><span><span style="background-color: transparent">        }</span></span><span><span style="background-color: transparent">
</span></span><span><span style="color: grey">12 </span></span><span><span style="background-color: transparent">        bucketOrds.get(i, spare.termBytes);</span></span><span><span style="background-color: transparent">
</span></span><span><span style="color: grey">13 </span></span><span><span style="background-color: transparent">        spare.docCount = bucketDocCount(i);</span></span><span><span style="background-color: transparent">
</span></span><span><span style="color: grey">14 </span></span><span><span style="background-color: transparent">        spare.bucketOrd = i;</span></span><span><span style="background-color: transparent">
</span></span><span><span style="color: grey">15 </span></span><span><span style="background-color: transparent">        spare = (</span></span><span style="color:grey; text-decoration: line-through;"><span style="color: black; background-color: rgb(255,187,187); font-weight: bold;">OrdinalBucket</span></span><span><span style="background-color: transparent">) ordered.insertWithOverflow(spare);</span></span><span><span style="background-color: transparent">
</span></span><span><span style="color: grey">16 </span></span><span><span style="background-color: transparent">    }</span></span><span><span style="background-color: transparent">
</span></span><span><span style="color: grey">17 </span></span><span><span style="background-color: transparent"></span></span><span><span style="background-color: transparent">
</span></span><span><span style="color: grey">18 </span></span><span><span style="background-color: transparent">    final InternalTerms.Bucket[] list = new InternalTerms.Bucket[ordered.size()];</span></span><span><span style="background-color: transparent">
</span></span><span><span style="color: grey">19 </span></span><span><span style="background-color: transparent">    for (int i = ordered.size() - 1; i &gt;= 0; --i) {</span></span><span><span style="background-color: transparent">
</span></span><span><span style="color: grey">20 </span></span><span><span style="background-color: transparent">        final </span></span><span style="color:grey; text-decoration: line-through;"><span style="color: black; background-color: rgb(255,187,187); font-weight: bold;">OrdinalBucket</span></span><span><span style="background-color: transparent"> bucket = (</span></span><span style="color:grey; text-decoration: line-through;"><span style="color: black; background-color: rgb(255,187,187); font-weight: bold;">OrdinalBucket</span></span><span><span style="background-color: transparent">) ordered.pop();</span></span><span><span style="background-color: transparent">
</span></span><span><span style="color: grey">21 </span></span><span><span style="background-color: transparent">        bucket.aggregations = bucketAggregations(bucket.bucketOrd);</span></span><span><span style="background-color: transparent">
</span></span><span><span style="color: grey">22 </span></span><span><span style="background-color: transparent">        list[i] = bucket;</span></span><span><span style="background-color: transparent">
</span></span><span><span style="color: grey">23 </span></span><span><span style="background-color: transparent">    }</span></span><span><span style="background-color: transparent">
</span></span><span><span style="color: grey">24 </span></span><span><span style="background-color: transparent">    return new StringTerms(name, order, requiredSize, Arrays.asList(list));</span></span><span><span style="background-color: transparent">
</span></span><span><span style="color: grey">25 </span></span><span><span style="background-color: transparent">}</span></span><span><span style="background-color: transparent">
</span></span><span><span style="color: grey">26 </span></span><span><span style="background-color: transparent"></span></span><span><span style="background-color: transparent">
</span></span></pre></td></tr></table></td><td style="border: 1px solid black; border-collapse: collapse;"><table><tr><th><strong>Modified</strong></th></tr><tr><td><pre><span><span style="color: grey"> 1 </span></span><span><span style="background-color: transparent">@Override</span></span><span><span style="background-color: transparent">
</span></span><span><span style="color: grey"> 2 </span></span><span><span style="background-color: transparent">public StringTerms buildAggregation(long owningBucketOrdinal) {</span></span><span><span style="background-color: transparent">
</span></span><span><span style="color: grey"> 3 </span></span><span><span style="background-color: transparent">    assert owningBucketOrdinal == 0;</span></span><span><span style="background-color: transparent">
</span></span><span><span style="color: grey"> 4 </span></span><span><span style="background-color: transparent">    final int size = (int) Math.min(bucketOrds.size(), shardSize);</span></span><span><span style="background-color: transparent">
</span></span><span><span style="color: grey"> 5 </span></span><span><span style="background-color: transparent"></span></span><span><span style="background-color: transparent">
</span></span><span><span style="color: grey"> 6 </span></span><span><span style="background-color: transparent">    BucketPriorityQueue ordered = new BucketPriorityQueue(size, order.comparator(</span></span><span><span style="background-color: rgb(0,250,108)  ; font-weight: bold;">this</span></span><span><span style="background-color: transparent">));</span></span><span><span style="background-color: transparent">
</span></span><span><span style="color: grey"> 7 </span></span><span><span style="background-color: transparent">    </span></span><span><span style="background-color: rgb(0,250,108)  ; font-weight: bold;">StringTerms.Bucket</span></span><span><span style="background-color: transparent"> spare = null;</span></span><span><span style="background-color: transparent">
</span></span><span><span style="color: grey"> 8 </span></span><span><span style="background-color: transparent">    for (int i = 0; i &lt; bucketOrds.size(); i</span></span><span><span style="background-color: rgb(0,250,108)  ; font-weight: bold;">++</span></span><span><span style="background-color: transparent">) {</span></span><span><span style="background-color: transparent">
</span></span><span><span style="color: grey"> 9 </span></span><span><span style="background-color: transparent">        if (spare == null) {</span></span><span><span style="background-color: transparent">
</span></span><span><span style="color: grey">10 </span></span><span><span style="background-color: transparent">            spare = new </span></span><span><span style="background-color: rgb(0,250,108)  ; font-weight: bold;">StringTerms.Bucket(new BytesRef(), 0, null)</span></span><span><span style="background-color: transparent">;</span></span><span><span style="background-color: transparent">
</span></span><span><span style="color: grey">11 </span></span><span><span style="background-color: transparent">        }</span></span><span><span style="background-color: transparent">
</span></span><span><span style="color: grey">12 </span></span><span><span style="background-color: transparent">        bucketOrds.get(i, spare.termBytes);</span></span><span><span style="background-color: transparent">
</span></span><span><span style="color: grey">13 </span></span><span><span style="background-color: transparent">        spare.docCount = bucketDocCount(i);</span></span><span><span style="background-color: transparent">
</span></span><span><span style="color: grey">14 </span></span><span><span style="background-color: transparent">        spare.bucketOrd = i;</span></span><span><span style="background-color: transparent">
</span></span><span><span style="color: grey">15 </span></span><span><span style="background-color: transparent">        spare = (</span></span><span><span style="background-color: rgb(0,250,108)  ; font-weight: bold;">StringTerms.Bucket</span></span><span><span style="background-color: transparent">) ordered.insertWithOverflow(spare);</span></span><span><span style="background-color: transparent">
</span></span><span><span style="color: grey">16 </span></span><span><span style="background-color: transparent">    }</span></span><span><span style="background-color: transparent">
</span></span><span><span style="color: grey">17 </span></span><span><span style="background-color: transparent"></span></span><span><span style="background-color: transparent">
</span></span><span><span style="color: grey">18 </span></span><span><span style="background-color: transparent">    final InternalTerms.Bucket[] list = new InternalTerms.Bucket[ordered.size()];</span></span><span><span style="background-color: transparent">
</span></span><span><span style="color: grey">19 </span></span><span><span style="background-color: transparent">    for (int i = ordered.size() - 1; i &gt;= 0; --i) {</span></span><span><span style="background-color: transparent">
</span></span><span><span style="color: grey">20 </span></span><span><span style="background-color: transparent">        final </span></span><span><span style="background-color: rgb(0,250,108)  ; font-weight: bold;">StringTerms.Bucket</span></span><span><span style="background-color: transparent"> bucket = (</span></span><span><span style="background-color: rgb(0,250,108)  ; font-weight: bold;">StringTerms.Bucket</span></span><span><span style="background-color: transparent">) ordered.pop();</span></span><span><span style="background-color: transparent">
</span></span><span><span style="color: grey">21 </span></span><span><span style="background-color: transparent">        bucket.aggregations = bucketAggregations(bucket.bucketOrd);</span></span><span><span style="background-color: transparent">
</span></span><span><span style="color: grey">22 </span></span><span><span style="background-color: transparent">        list[i] = bucket;</span></span><span><span style="background-color: transparent">
</span></span><span><span style="color: grey">23 </span></span><span><span style="background-color: transparent">    }</span></span><span><span style="background-color: transparent">
</span></span><span><span style="color: grey">24 </span></span><span><span style="background-color: transparent">    return new StringTerms(name, order, requiredSize, Arrays.asList(list));</span></span><span><span style="background-color: transparent">
</span></span><span><span style="color: grey">25 </span></span><span><span style="background-color: transparent">}</span></span><span><span style="background-color: transparent">
</span></span><span><span style="color: grey">26 </span></span><span><span style="background-color: transparent"></span></span><span><span style="background-color: transparent">
</span></span></pre></td></tr></table></td></tr></table></div></body></html>